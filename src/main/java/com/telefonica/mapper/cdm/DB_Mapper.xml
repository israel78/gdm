<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.telefonica.mapper.cdm.DB_Mapper">

	<select id="selectBySQL" parameterType="Map"
		resultType="java.util.HashMap">
	<![CDATA[
	${sql};
	]]>
	</select>

	<!-- insertBySQL(@Param("sql") String sSQL); -->
	<insert id="insertBySQL" parameterType="Map">
	<![CDATA[
	${sql};
	]]>
	</insert>

	<!-- updateBySQL(@Param("sql") String sSQL); -->
	<update id="updateBySQL" parameterType="Map">
	<![CDATA[
	${sql};
	]]>
	</update>

	<!-- deleteBySQL(@Param("sql") String sSQL); -->
	<delete id="deleteBySQL" parameterType="Map">
	<![CDATA[
	${sql};
	]]>
	</delete>


	<!-- ***************************************** -->
	<!-- CONEXIÓN A BD AUTOMÁTICA PARA NO PERDERLA -->
	<!-- ***************************************** -->

	<!-- Date selectNow(): Obtenemos la fecha/hora del servidor de BD -->
	<select id="selectNow" resultType="java.util.Date">
	<![CDATA[
	-- leemos sin esperar a que se desbloquee la(s) tabla(s). SELECTs más rápidos.
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

	-- MySQL. Fecha/Hora actual.
	-- SELECT NOW();
	--
	-- Microsoft SQL Server. Fecha/Hora actual.
	SELECT GETDATE();
	]]>
	</select>


	<select id="selectUsuarioByMatricula" parameterType="string"
		resultType="com.telefonica.entity.Usuario">
	<![CDATA[
	-- leemos sin esperar a que se desbloquee la(s) tabla(s). SELECTs más rápidos.
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

	SELECT top 1 ID_USUARIO,
	MATRICULA,
	PASSWORD,
	NOMBRE,
	APELLIDO_1,
	APELLIDO_2,
	ACTIVO,
	F_ALTA,
	F_BAJA,
	CENTRO,
	CARGO,
	ENVIAR_CORREO
	FROM web.Usuarios
	WHERE MATRICULA = #{matricula}
	]]>
	</select>
	<select id="selectMaxSemanaIncidencias"
		resultType="java.lang.Integer">
	<![CDATA[
	-- leemos sin esperar a que se desbloquee la(s) tabla(s). SELECTs más rápidos.
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

		declare @semana_incidencias INT
	declare @semana_incidencias_ti INT
	
	SELECT @semana_incidencias_ti = datepart(WK,max(fecha)) from CDM_PBI.dbo.listado_incidencias_ti;
	select @semana_incidencias =  datepart(WK,max(fecha)) from CDM_PBI.dbo.listado_incidencias;
	
	IF (@semana_incidencias_ti >= @semana_incidencias) BEGIN 
			select @semana_incidencias_ti
		end 
		else
		begin
			select @semana_incidencias
		end
	
	]]>
	</select>
	<select id="selectMaxFechaIncidencias"
		resultType="java.util.Date">
	<![CDATA[
	-- leemos sin esperar a que se desbloquee la(s) tabla(s). SELECTs más rápidos.
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

		declare @semana_incidencias INT
	declare @semana_incidencias_ti INT
	
	SELECT @semana_incidencias_ti = datepart(WK,max(fecha)) from CDM_PBI.dbo.listado_incidencias_ti;
	select @semana_incidencias =  datepart(WK,max(fecha)) from CDM_PBI.dbo.listado_incidencias;
	
	IF (@semana_incidencias_ti >= @semana_incidencias) BEGIN 
			 SELECT max(fecha) from dbo.listado_incidencias_ti;
		end 
		else
		begin
			SELECT max(fecha) from dbo.listado_incidencias;
		end
	
	]]>
	</select>
	<select id="selectMaxMesIncidencias"
		resultType="java.lang.Integer">
	<![CDATA[
	-- leemos sin esperar a que se desbloquee la(s) tabla(s). SELECTs más rápidos.
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

		declare @mes_incidencias INT
	declare @mes_incidencias_ti INT
	
	SELECT @mes_incidencias_ti = datepart(mm,max(fecha)) from CDM_PBI.dbo.listado_incidencias_ti;
	select @mes_incidencias =  datepart(mm,max(fecha)) from CDM_PBI.dbo.listado_incidencias;
	
	IF (@mes_incidencias_ti >= @mes_incidencias) BEGIN 
			select @mes_incidencias_ti
		end 
		else
		begin
			select @mes_incidencias
		end
	
	]]>
	</select>
	<select id="buscarIncidenciasByFilters"
		parameterType="com.telefonica.entity.InBusquedaIncidencias"
		resultType="com.telefonica.entity.IncidenciasRelevantes">

		-- leemos sin esperar a que se desbloquee la(s) tabla(s). SELECTs másrápidos.
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;


		<if test="tipoIncidencia == 'RSS'">

			SELECT *
			FROM
			(

			select distinct i.id as num_incidencia,
			'RSS' as tipo,
			i.tipo as tipoSemMes,
			ACI_DESCRIPCION as descripcion,
			i.severidad,
			i.fecha as fecha,
			i.fecha_creacion as fecha_inicio,
			i.fecha_cierre as fecha_fin,
			'' as alias,
			'' as servicio_afectado,
			'' as causa,
			'' as acciones_recuperacion,
			'' as acciones_mejora_responsables,
			'' as contacto,
			'' as area,
			i.provincia as cod_provincia,
			i.BA_Indisponibilidad+i.TV_Indisponibilidad+i.Voz_Indisponibilidad+i.MFE_Indisponibilidad
			as indisponibilidad,
			(select p.provincia from dbo.provincias p where p.cod_provincia =
			i.provincia) as provincia
			from dbo.listado_incidencias i
			where not exists (select * from web.incidencias_relevantes r where
			r.Num_incidencia = i.id and r.fecha = i.fecha and r.cod_provincia =
			i.provincia and r.TipoSemMes = i.tipo )
			<if test="numIncidencia != null  and numIncidencia != '' ">
				and (i.id = #{numIncidencia})
			</if>
			<if test="tipoBusqueda == 'SEMANAL'">
				and i.tipo ='Sem'
				and datepart(wk,i.fecha) =
				#{numSemanaMes}
				and YEAR(i.fecha) = #{annioBusqueda}

			</if>
			<if test="tipoBusqueda == 'MENSUAL'">
				and i.tipo ='Mes'
				and datepart(mm,i.fecha) =
				#{numSemanaMes}
				and YEAR(i.fecha) = #{annioBusqueda}
			</if>

			union all

			select distinct
			r.num_incidencia,
			r.tipo,
			r.TipoSemMes as TipoSemMes,
			r.descripcion,
			r.severidad,
			r.fecha as fecha,
			r.fecha_inicio,
			r.fecha_fin,
			r.alias,
			r.servicio_afectado,
			r.causa,
			r.acciones_recuperacion,
			r.acciones_mejora_responsables,
			r.contacto,
			r.area,
			r.cod_provincia as cod_provincia,
			r.indisponibilidad,
			(select p.provincia from dbo.provincias p where p.cod_provincia =
			r.cod_provincia) as provincia
			from web.incidencias_relevantes r
			where r.tipo = 'RSS'
			<if test="numIncidencia !=null and numIncidenciaCopia != '' ">
				and (r.num_incidencia = #{numIncidencia})
			</if>
			<if test="tipoBusqueda == 'SEMANAL'">
				and r.TipoSemMes = 'Sem'
				and datepart(WK,r.fecha) =
				#{numSemanaMes}
				and YEAR(r.fecha) = #{annioBusqueda}
			</if>
			<if test="tipoBusqueda == 'MENSUAL'">
				and r.TipoSemMes = 'Mes'
				and datepart(mm,r.fecha) =
				#{numSemanaMes}
				and YEAR(r.fecha) = #{annioBusqueda}

			</if>
			) incidencias order by

			<if test="numIncidencia != null  and numIncidencia != '' ">

				fecha DESC
			</if>
			<if test="numIncidencia == '' ">

				num_incidencia DESC
			</if>
			;
		</if>

		<if test="tipoIncidencia == 'TI'">

			SELECT *
			FROM
			(

			select distinct
			i.id as num_incidencia,
			'TI' as tipo,
			'' as tipoSemMes,
			i.descripcion,
			i.severidad,
			i.fecha as fecha,
			i.hora_inicio as fecha_inicio,
			i.hora_fin as fecha_fin,
			'' as alias,
			'' as servicio_afectado,
			'' as causa,
			'' as acciones_recuperacion,
			'' as acciones_mejora_responsables,
			'' as contacto,
			'' as area,
			'' as cod_provincia,
			i.duracion as indisponibilidad,
			'' as provincia
			from dbo.listado_incidencias_TI i
			where not exists(select * from web.incidencias_relevantes r where
			r.Num_incidencia = i.id and r.fecha = i.fecha and r.tipo = 'TI' )
			<if test="numIncidencia !=null and  numIncidencia != '' ">
				and i.id = #{numIncidencia}
			</if>
			<if test="tipoBusqueda == 'SEMANAL'">
				and datepart(WK,i.fecha) = #{numSemanaMes}
				and
				YEAR(i.fecha) = #{annioBusqueda}

			</if>
			<if test="tipoBusqueda == 'MENSUAL'">
				and datepart(mm,i.fecha) = #{numSemanaMes}
				and
				YEAR(i.fecha) = #{annioBusqueda}
			</if>

			union all

			select distinct
			r.num_incidencia,
			r.tipo,
			'' as tipoSemMes,
			r.descripcion,
			r.severidad,
			r.fecha as fecha,
			r.fecha_inicio,
			r.fecha_fin,
			r.alias,
			r.servicio_afectado,
			r.causa,
			r.acciones_recuperacion,
			r.acciones_mejora_responsables,
			r.contacto,
			r.area,
			r.cod_provincia as cod_provincia,
			r.indisponibilidad,
			'' as provincia
			from web.incidencias_relevantes r
			where r.tipo = 'TI'
			<if test="numIncidencia != null  and numIncidencia != '' ">
				and r.num_incidencia = #{numIncidencia}
			</if>
			<if test="tipoBusqueda == 'SEMANAL'">
				and datepart(WK,r.fecha) = #{numSemanaMes}
				and
				YEAR(r.fecha) = #{annioBusqueda}
			</if>
			<if test="tipoBusqueda == 'MENSUAL'">
				and datepart(mm,r.fecha) = #{numSemanaMes}
				and YEAR(r.fecha) = #{annioBusqueda}
			</if>


			) incidencias order by

			<if test="numIncidencia != null  and numIncidencia != '' ">

				fecha DESC
			</if>
			<if test="numIncidencia == '' ">

				num_incidencia DESC
			</if>
			;
		</if>
	</select>
	<select id="buscarIncidenciasRelevantesByFilters"
		parameterType="com.telefonica.entity.IncidenciasRelevantes"
		resultType="com.telefonica.entity.IncidenciasRelevantes">

		-- leemos sin esperar a que se desbloquee la(s) tabla(s). SELECTs másrápidos.
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;


		SELECT id,
		id_comite,
		isnull([INDEX],0) as [INDEX],
		anno_cdm,
		semana,
		fecha_cdm,
		n_incidencia,
		tipo,
		subtipo,
		descripcion,
		severidad, 
		fecha_inicio, 
		fecha_fin, 
		indisponibilidad, 
		alias, 
		servicio_afectado, 
		causa, 
		acciones_recuperacion, 
		acciones_mejora_responsables, 
		contacto, 
		area, 
		autor, 
		F_registro as [timestamp]
		FROM CDM_PBI.web.Incidencias_relevantes

		where 1=1

		<if test="id  != '' ">
			and id = #{id}
		</if>
		<if test="id  == '' ">
			<if test="tipo != null and tipo != '' ">
				and tipo = #{tipo}
			</if>
			<if test=" subtipo != null  and subtipo != '' ">
				and subtipo = #{subtipo}
			</if>
			<if test=" n_incidencia != null  and n_incidencia != '' ">
				and n_incidencia = #{n_incidencia}
			</if>
			<if test="fecha_inicio != null ">
				and fecha_inicio >= #{fecha_inicio}
			</if>
			<if test="fecha_fin!= null ">	
			and fecha_fin <![CDATA[ < ]]> #{fecha_fin} 
			</if>
				and  semana = #{semana}
				and anno_cdm = #{anno_cdm}
				
			
		</if>
		;
			
		
	</select>
	<select id="buscarAccionesByFilters"
		parameterType="com.telefonica.entity.InBusquedaAcciones"
		resultType="com.telefonica.entity.AccionesRelevantes">
		SELECT id,
			Tipo,
			isnull(Subtipo,'') as Subtipo,
			Fecha_inicio,
			Fecha_fin,
			Titulo,
			codigo_BTP_CRQ,
			Descripcion,
			isnull(Impacto,'') as Impacto,
			isnull(Motivo,'') as Motivo,
			Promotor,
			Unidad_ejecutora,
			Usuario_contacto,
			Area,
			Fecha_CDM,
			isnull(Id_comite,'') as Id_comite,
			[Index],
			Anno_cdm,
			Semana,
			Autor,
			[Timestamp]
			FROM CDM_PBI.web.detalle_acciones_relevantes

		where 1=1

		<if test="id != null  and id != '' ">
			and id = #{id}
		</if>
		<if test=" id == null  or id == '' ">
			<if test="tipo != '' ">
				and Tipo = #{tipo}
			</if>
			<if test=" subtipo != null  and subtipo != '' ">
				and Subtipo = #{subtipo}
			</if>
			<if test="numSemanaMes != null  and numSemanaMes != '' ">
				and  Semana = #{numSemanaMes}
				and Anno_cdm = #{annioBusqueda}
			</if>
			<if test="numSemanaMes == null or numSemanaMes == '' ">
				<if test="fecha_inicio != null ">
					and Fecha_inicio >= #{fecha_inicio}
				</if>
				<if test="fecha_fin!= null ">	
				<![CDATA[and Fecha_fin <=  #{fecha_fin} ]]>
				</if>
			</if>
		</if>
		;
	</select>
	
		<select id="buscarComentariosByFilters"
		parameterType="com.telefonica.entity.InComentarios"
		resultType="com.telefonica.entity.Comentarios">
		
		
			SELECT *
			FROM CDM_PBI.web.comentarios c
			where 1=1

		<if test="vista != null  and vista != '' ">
			and c.vista = #{vista}
		</if>
	
		<if test="tipoBusqueda == 'SEMANAL'">
			and datepart(iso_week,c.fecha) = #{numSemanaMes}
			and	YEAR(c.fecha) = #{annioBusqueda}
			and c.Tipo_periodo = 'SEMANAL'
		</if>
		<if test="tipoBusqueda == 'MENSUAL'">
			and datepart(mm,c.fecha) = #{numSemanaMes}
			and YEAR(c.fecha) = #{annioBusqueda}
			and c.Tipo_periodo = 'MENSUAL'
			
		</if>
		<if test=" kpi != null  and kpi != '' ">
			and c.KPI = #{kpi}
		</if>
		
		;
	</select>
			<select id="buscarComentariosIncidenciasByFilters"
		parameterType="com.telefonica.entity.InComentarios"
		resultType="com.telefonica.entity.ComentariosIncidencias">
		
		
			SELECT *
			FROM CDM_PBI.web.Desc_inc_destacadas c
			where 1=1
		<if test="tipoBusqueda == 'SEMANAL'">
			and N_periodo = #{numSemanaMes}
			and	YEAR(c.fecha) = #{annioBusqueda}
			and c.Tipo_periodo = 'SEMANAL'
		</if>
		<if test="tipoBusqueda == 'MENSUAL'">
			and N_periodo = #{numSemanaMes}
			and YEAR(c.fecha) = #{annioBusqueda}
			and c.Tipo_periodo = 'MENSUAL'
			
		</if>
		;
	</select>
	
	<select id="buscarIncidenciasRegularizadasByFilters"
		parameterType="com.telefonica.entity.inRegularizaciones"
		resultType="com.telefonica.entity.listadoIncidenciasRegularizada">
		
			SELECT
	       Tipo as  tipo, 
			Red as  red,
			Equipo as  equipo,
			Provincia as  provincia,
			ID as  id,
			RESPONSABLE as  responsable,
			Fecha_Creacion as  fechaCreacion,
			Fecha_Reparacion as  fechaReparacion,
			Fecha_Franqueo as  fechaFranqueo,
			Fecha_Cierre as  fechaCierre,
			BA_Cobre_Clientes as  baCobreClientes,
			BA_Cobre_Indisponibilidad_Ponderada as  baCobreIndisponibilidadPonderada,
			BA_Cobre_Duracion_Ponderada as  baCobreDuracionPonderada,
			BA_Cobre_Indisponibilidad as  baCobreIndisponibilidad,
			BA_Cobre_Duracion as  baCobreDuracion,
			BA_Fibra_Clientes as  baFibraClientes,
			BA_Fibra_Indisponibilidad_Ponderada as  baFibraIndisponibilidadPonderada,
			BA_Fibra_Duracion_Ponderada as  baFibraDuracionPonderada,
			BA_Fibra_Indisponibilidad as  baFibraIndisponibilidad,
			BA_Fibra_Duracion as  baFibraDuracion,
			BA_Clientes as  baClientes,
			BA_Indisponibilidad_Ponderada as  baIndisponibilidadPonderada,
			BA_Duracion_Ponderada as  baDuracionPonderada,
			BA_Indisponibilidad as  baIndisponibilidad,
			BA_Duracion as  baDuracion,
			Tv_Cobre_Clientes as  tvCobreClientes,
			Tv_Cobre_Indisponibilidad_Ponderada as  tvCobreIndisponibilidadPonderada,
			Tv_Cobre_Duracion_Ponderada as  tvCobreDuracionPonderada,
			Tv_Cobre_Indisponibilidad as  tvCobreIndisponibilidad,
			Tv_Cobre_Duracion as  tvCobreDuracion,
			Tv_Fibra_Clientes as  tvFibraClientes,
			Tv_Fibra_Indisponibilidad_Ponderada as  tvFibraIndisponibilidadPonderada,
			Tv_Fibra_Duracion_Ponderada as  tvFibraDuracionPonderada,
			Tv_Fibra_Indisponibilidad as  tvFibraIndisponibilidad,
			Tv_Fibra_Duracion as  tvFibraDuracion,
			Tv_Clientes as  tvClientes,
			Tv_Indisponibilidad_Ponderada as  tvIndisponibilidadPonderada,
			Tv_Duracion_Ponderada as  tvDuracionPonderada,
			Tv_Indisponibilidad as  tvIndisponibilidad,
			Tv_Duracion as  tvDuracion,
			Voz_Cobre_Clientes as  vozCobreClientes,
			Voz_Cobre_Indisponibilidad_Ponderada as  vozCobreIndisponibilidadPonderada,
			Voz_Cobre_Duracion_Ponderada as  vozCobreDuracionPonderada,
			Voz_Cobre_Indisponibilidad as  vozCobreIndisponibilidad,
			Voz_Cobre_Duracion as  vozCobreDuracion,
			Voz_Fibra_Clientes as  vozFibraClientes,
			Voz_Fibra_Indisponibilidad_Ponderada as  vozFibraIndisponibilidadPonderada,
			Voz_Fibra_Duracion_Ponderada as  vozFibraDuracionPonderada,
			Voz_Fibra_Indisponibilidad as  vozFibraIndisponibilidad,
			Voz_Fibra_Duracion as  vozFibraDuracion,
			Voz_Clientes as  vozClientes,
			Voz_Indisponibilidad_Ponderada as  vozIndisponibilidadPonderada, 
			Voz_Duracion_Ponderada as  vozDuracionPonderada, 
			Voz_Indisponibilidad as  vozIndisponibilidad,
			Voz_Duracion as  vozDuracion,
			MFE_Clientes as  mfeClientes,
			MFE_Indisponibilidad_Ponderada as  mfeIndisponibilidadPonderada,
			MFE_Duracion_Ponderada as  mfeDuracionPonderada,
			MFE_Indisponibilidad as  mfeIndisponibilidad, 
			MFE_Duracion as  mfeDuracion,
			FQ1 as  fq1,
			FQ2 as  fq2,
			FQ3 as  fq3,
			FQ4 as  fq4,
			FQ5 as  fq5,
			FQ6 as  fq6,
			SUMINISTRADOR as  suministrador,
			TECNOLOGIA as  tecnologia,
			MODELO as  modelo,
			TIPO_DE_SINTOMA as  tipoDeSintoma,
			Falta_Repuesto as  faltaRepuesto,
			Tiempo_Metereologico as  tiempoMetereologico,
			Fecha as  fecha,
			Causa as  causa,
			Causa_igri as  causaIgri,
			Subcausa_igri as  subcausaIgri,
			SEVERIDAD as  severidad,
			ACI_F_INICIO as  aciFInicio,
			ACI_F_FIN as  aciFFin,
			ACI_DESCRIPCION as  aciDescripcion,
			ACI_CAUSA as  aciCausa,
			ACI_SAF as  aciSaf,
			ACI_ANALISIS as  aciAnalisis,
			ACI_SEVERIDAD as  aciSeveridad,
			ACI_LOCALIZACION as  aciLocalizacion,
			id_problema as  idProblema,
			concat_inc_1 as  concatInc1,
			concat_inc_ave_pla as  concatIncAvePla,
			concat_inc_ave_pla_2 as  concatIncAvePla2,
			Red_Incidencia as  redIncidencia,
			edificio_dslam as  edificioDslam,
			SUPERMASIVAS as  supermasivas,
			estado_gestion as  estadoGestion,
			NEBA_FIBRA_CLIENTES as  nebaFibraClientes,
			NEBA_FIBRA_INDISPONIBILIDAD as  nebaFibraIndisponibilidad,
			NEBA_LOCAL_CLIENTES as  nebaLocalClientes,
			NEBA_LOCAL_INDISPONIBILIDAD as  nebaLocalIndisponibilidad,
			NEBA_COBRE_CLIENTES as  nebaCobreClientes,
			NEBA_COBRE_INDISPONIBILIDAD as  nebaCobreIndisponibilidad,
			NEBA_FIBRA_DURACION as  nebaFibraDuracion,
			NEBA_LOCAL_DURACION as  nebaLocalDuracion,
			NEBA_COBRE_DURACION as  nebaCobreDuracion
	FROM
	        CDM_PBI.dbo.listado_incidencias
	WHERE
	        NOT EXISTS
	        (
	                SELECT
	                        1
	                FROM
	                        CDM_PBI.web.listado_incidencias_regularizada R
	                WHERE DATEPART(iso_week,Fecha) = #{numSemanaMes}
					AND     ID                       = #{id_incidencia}
					        and Provincia = #{provincia}
					AND     tipo = #{tipo}
					and 	DATEPART(YEAR,fecha) = #{annioBusqueda})
	AND     DATEPART(iso_week,Fecha) = #{numSemanaMes}
	AND     ID                       = #{id_incidencia}
	        and Provincia = #{provincia}
	AND     tipo = #{tipo}
	and 	DATEPART(YEAR,fecha) = #{annioBusqueda}
	
	UNION ALL
	
	SELECT
	       Tipo as  tipo, 
			Red as  red,
			Equipo as  equipo,
			Provincia as  provincia,
			ID as  id,
			RESPONSABLE as  responsable,
			Fecha_Creacion as  fechaCreacion,
			Fecha_Reparacion as  fechaReparacion,
			Fecha_Franqueo as  fechaFranqueo,
			Fecha_Cierre as  fechaCierre,
			BA_Cobre_Clientes as  baCobreClientes,
			BA_Cobre_Indisponibilidad_Ponderada as  baCobreIndisponibilidadPonderada,
			BA_Cobre_Duracion_Ponderada as  baCobreDuracionPonderada,
			BA_Cobre_Indisponibilidad as  baCobreIndisponibilidad,
			BA_Cobre_Duracion as  baCobreDuracion,
			BA_Fibra_Clientes as  baFibraClientes,
			BA_Fibra_Indisponibilidad_Ponderada as  baFibraIndisponibilidadPonderada,
			BA_Fibra_Duracion_Ponderada as  baFibraDuracionPonderada,
			BA_Fibra_Indisponibilidad as  baFibraIndisponibilidad,
			BA_Fibra_Duracion as  baFibraDuracion,
			BA_Clientes as  baClientes,
			BA_Indisponibilidad_Ponderada as  baIndisponibilidadPonderada,
			BA_Duracion_Ponderada as  baDuracionPonderada,
			BA_Indisponibilidad as  baIndisponibilidad,
			BA_Duracion as  baDuracion,
			Tv_Cobre_Clientes as  tvCobreClientes,
			Tv_Cobre_Indisponibilidad_Ponderada as  tvCobreIndisponibilidadPonderada,
			Tv_Cobre_Duracion_Ponderada as  tvCobreDuracionPonderada,
			Tv_Cobre_Indisponibilidad as  tvCobreIndisponibilidad,
			Tv_Cobre_Duracion as  tvCobreDuracion,
			Tv_Fibra_Clientes as  tvFibraClientes,
			Tv_Fibra_Indisponibilidad_Ponderada as  tvFibraIndisponibilidadPonderada,
			Tv_Fibra_Duracion_Ponderada as  tvFibraDuracionPonderada,
			Tv_Fibra_Indisponibilidad as  tvFibraIndisponibilidad,
			Tv_Fibra_Duracion as  tvFibraDuracion,
			Tv_Clientes as  tvClientes,
			Tv_Indisponibilidad_Ponderada as  tvIndisponibilidadPonderada,
			Tv_Duracion_Ponderada as  tvDuracionPonderada,
			Tv_Indisponibilidad as  tvIndisponibilidad,
			Tv_Duracion as  tvDuracion,
			Voz_Cobre_Clientes as  vozCobreClientes,
			Voz_Cobre_Indisponibilidad_Ponderada as  vozCobreIndisponibilidadPonderada,
			Voz_Cobre_Duracion_Ponderada as  vozCobreDuracionPonderada,
			Voz_Cobre_Indisponibilidad as  vozCobreIndisponibilidad,
			Voz_Cobre_Duracion as  vozCobreDuracion,
			Voz_Fibra_Clientes as  vozFibraClientes,
			Voz_Fibra_Indisponibilidad_Ponderada as  vozFibraIndisponibilidadPonderada,
			Voz_Fibra_Duracion_Ponderada as  vozFibraDuracionPonderada,
			Voz_Fibra_Indisponibilidad as  vozFibraIndisponibilidad,
			Voz_Fibra_Duracion as  vozFibraDuracion,
			Voz_Clientes as  vozClientes,
			Voz_Indisponibilidad_Ponderada as  vozIndisponibilidadPonderada, 
			Voz_Duracion_Ponderada as  vozDuracionPonderada, 
			Voz_Indisponibilidad as  vozIndisponibilidad,
			Voz_Duracion as  vozDuracion,
			MFE_Clientes as  mfeClientes,
			MFE_Indisponibilidad_Ponderada as  mfeIndisponibilidadPonderada,
			MFE_Duracion_Ponderada as  mfeDuracionPonderada,
			MFE_Indisponibilidad as  mfeIndisponibilidad, 
			MFE_Duracion as  mfeDuracion,
			FQ1 as  fq1,
			FQ2 as  fq2,
			FQ3 as  fq3,
			FQ4 as  fq4,
			FQ5 as  fq5,
			FQ6 as  fq6,
			SUMINISTRADOR as  suministrador,
			TECNOLOGIA as  tecnologia,
			MODELO as  modelo,
			TIPO_DE_SINTOMA as  tipoDeSintoma,
			Falta_Repuesto as  faltaRepuesto,
			Tiempo_Metereologico as  tiempoMetereologico,
			Fecha as  fecha,
			Causa as  causa,
			Causa_igri as  causaIgri,
			Subcausa_igri as  subcausaIgri,
			SEVERIDAD as  severidad,
			ACI_F_INICIO as  aciFInicio,
			ACI_F_FIN as  aciFFin,
			ACI_DESCRIPCION as  aciDescripcion,
			ACI_CAUSA as  aciCausa,
			ACI_SAF as  aciSaf,
			ACI_ANALISIS as  aciAnalisis,
			ACI_SEVERIDAD as  aciSeveridad,
			ACI_LOCALIZACION as  aciLocalizacion,
			id_problema as  idProblema,
			concat_inc_1 as  concatInc1,
			concat_inc_ave_pla as  concatIncAvePla,
			concat_inc_ave_pla_2 as  concatIncAvePla2,
			Red_Incidencia as  redIncidencia,
			edificio_dslam as  edificioDslam,
			SUPERMASIVAS as  supermasivas,
			estado_gestion as  estadoGestion,
			NEBA_FIBRA_CLIENTES as  nebaFibraClientes,
			NEBA_FIBRA_INDISPONIBILIDAD as  nebaFibraIndisponibilidad,
			NEBA_LOCAL_CLIENTES as  nebaLocalClientes,
			NEBA_LOCAL_INDISPONIBILIDAD as  nebaLocalIndisponibilidad,
			NEBA_COBRE_CLIENTES as  nebaCobreClientes,
			NEBA_COBRE_INDISPONIBILIDAD as  nebaCobreIndisponibilidad,
			NEBA_FIBRA_DURACION as  nebaFibraDuracion,
			NEBA_LOCAL_DURACION as  nebaLocalDuracion,
			NEBA_COBRE_DURACION as  nebaCobreDuracion
	FROM
	        CDM_PBI.web.listado_incidencias_regularizada
	WHERE
	        DATEPART(iso_week,Fecha) = #{numSemanaMes}
	AND     ID                       = #{id_incidencia}
	        and Provincia = #{provincia}
	AND     tipo = #{tipo}
	and 	DATEPART(YEAR,fecha) = #{annioBusqueda}
	</select>
	
	<select id="buscarIncidenciasLlamadasRegularizadasByFilters"
		parameterType="com.telefonica.entity.inRegularizaciones"
		resultType="com.telefonica.entity.ListadoIncidenciasDisponibilidadLlamadasRegularizada">
		
		SELECT
        fecha                AS fecha              ,
        SEC_SUPERIOR         AS secSuperior        ,
        PROVINCIA            AS provincia          ,
        TIPO                 AS tipo               ,
        DATOS_COBRE          AS datosCobre         ,
        DATOS_FIBRA          AS datosFibra         ,
        VOZ                  AS voz                ,
        VOZ_IP               AS vozIp              ,
        TV_COBRE             AS tvCobre            ,
        TV_FIBRA             AS tvFibra            ,
        TV                   AS tv                 ,
        MFE                  AS mfe                ,
        DTH                  AS dth                ,
        OTT                  AS ott                ,
        NETFLIX              AS netflix            ,
        DISNEY               AS disney             ,
        CLIE_DATOS_COBRE     AS clieDatosCobre     ,
        CLIE_DATOS_FIBRA     AS clieDatosFibra     ,
        CLIE_VOZ             AS clieVoz            ,
        CLIE_VOZ_IP          AS clieVozIp          ,
        CLIE_TV_COBRE        AS clieTvCobre        ,
        CLIE_TV_FIBRA        AS clieTvFibra        ,
        CLIE_TV              AS clieTv             ,
        CLIE_MFE             AS clieMfe            ,
        CLIE_DTH             AS clieDth            ,
        CLIE_OTT             AS clieOtt            ,
        CLIE_NETFLIX         AS clieNetflix        ,
        CLIE_DISNEY          AS clieDisney         ,
        DURACION_DATOS_COBRE AS duracionDatosCobre ,
        DURACION_DATOS_FIBRA AS duracionDatosFibra ,
        DURACION_VOZ         AS duracionVoz        ,
        DURACION_VOZ_IP      AS duracionVozIp      ,
        DURACION_TV_COBRE    AS duracionTvCobre    ,
        DURACION_TV_FIBRA    AS duracionTvFibra    ,
        DURACION_TV          AS duracionTv         ,
        DURACION_MFE         AS duracionMfe        ,
        DURACION_DTH         AS duracionDth        ,
        DURACION_OTT         AS duracionOtt        ,
        DURACION_NETFLIX     AS duracionNetflix    ,
        DURACION_DISNEY      AS duracionDisney
FROM
        CDM_PBI.dbo.listado_Incidencias_Disponibilidad_Llamadas
WHERE
        NOT EXISTS
        (
                SELECT
                        1
                FROM
                        CDM_PBI.web.listado_Incidencias_Disponibilidad_Llamadas_regularizada R
                WHERE
                        DATEPART(iso_week,Fecha) = #{numSemanaMes}
						AND     SEC_SUPERIOR                       = #{id_incidencia}
						        and Provincia = #{provincia}
						AND     tipo = #{tipo}
						and 	DATEPART(YEAR,fecha) = #{annioBusqueda})
	AND    DATEPART(iso_week,Fecha) = #{numSemanaMes}
	AND     SEC_SUPERIOR                       = #{id_incidencia}
	        and Provincia = #{provincia}
	AND     tipo = #{tipo}
	and 	DATEPART(YEAR,fecha) = #{annioBusqueda}

UNION ALL

SELECT
        fecha                AS fecha              ,
        SEC_SUPERIOR         AS secSuperior        ,
        PROVINCIA            AS provincia          ,
        TIPO                 AS tipo               ,
        DATOS_COBRE          AS datosCobre         ,
        DATOS_FIBRA          AS datosFibra         ,
        VOZ                  AS voz                ,
        VOZ_IP               AS vozIp              ,
        TV_COBRE             AS tvCobre            ,
        TV_FIBRA             AS tvFibra            ,
        TV                   AS tv                 ,
        MFE                  AS mfe                ,
        DTH                  AS dth                ,
        OTT                  AS ott                ,
        NETFLIX              AS netflix            ,
        DISNEY               AS disney             ,
        CLIE_DATOS_COBRE     AS clieDatosCobre     ,
        CLIE_DATOS_FIBRA     AS clieDatosFibra     ,
        CLIE_VOZ             AS clieVoz            ,
        CLIE_VOZ_IP          AS clieVozIp          ,
        CLIE_TV_COBRE        AS clieTvCobre        ,
        CLIE_TV_FIBRA        AS clieTvFibra        ,
        CLIE_TV              AS clieTv             ,
        CLIE_MFE             AS clieMfe            ,
        CLIE_DTH             AS clieDth            ,
        CLIE_OTT             AS clieOtt            ,
        CLIE_NETFLIX         AS clieNetflix        ,
        CLIE_DISNEY          AS clieDisney         ,
        DURACION_DATOS_COBRE AS duracionDatosCobre ,
        DURACION_DATOS_FIBRA AS duracionDatosFibra ,
        DURACION_VOZ         AS duracionVoz        ,
        DURACION_VOZ_IP      AS duracionVozIp      ,
        DURACION_TV_COBRE    AS duracionTvCobre    ,
        DURACION_TV_FIBRA    AS duracionTvFibra    ,
        DURACION_TV          AS duracionTv         ,
        DURACION_MFE         AS duracionMfe        ,
        DURACION_DTH         AS duracionDth        ,
        DURACION_OTT         AS duracionOtt        ,
        DURACION_NETFLIX     AS duracionNetflix    ,
        DURACION_DISNEY      AS duracionDisney
FROM
        CDM_PBI.web.listado_Incidencias_Disponibilidad_Llamadas_regularizada
WHERE
        DATEPART(iso_week,Fecha) = #{numSemanaMes}
	AND     SEC_SUPERIOR                      = #{id_incidencia}
	        and Provincia = #{provincia}
	AND     tipo = #{tipo}
	and 	DATEPART(YEAR,fecha) = #{annioBusqueda}
		
	</select>
	<select id="buscarDatosAdicionalesRegularizacionesByFilters"
		parameterType="com.telefonica.entity.inRegularizaciones"
		resultType="com.telefonica.entity.DatosAdicionalesRegularizaciones">
				
		SELECT
		        id            ,
		        tipo          ,
		        id_incidencia as idIncidencia,
		        sec_superior  as secSuperior ,
		        Fecha         as fecha,
		        descripcion   ,
		        solicitante   ,
		        autorizador   ,
		        provincia     ,
		        eliminar      ,
		        fecha_registro as fechaRegistro,
		        autor
		FROM
		        CDM_PBI.web.datos_adicionales_regularizaciones
		where   id_incidencia = #{id_incidencia}
	    and     Provincia = #{provincia}
		AND     tipo = #{tipo}
		and 	DATEPART(YEAR,fecha) = #{annioBusqueda} 
	
	</select>	
	
	
	<select id="buscarProvincias"
		resultType="com.telefonica.entity.provincias">
		SELECT cod_provincia, provincia, territorio
		FROM CDM_PBI.dbo.provincias;
	</select>	
	<select id="buscarKPIS"
		resultType="com.telefonica.entity.KPIVistas">
		select Id_Titulo, KPI, vista from CDM_PBI.web.KPI_vistas_xlsx order by id_Titulo asc;
	</select>
		<select id="buscarVistas"
		resultType="com.telefonica.entity.Vista">
		select distinct id_Titulo, vista from CDM_PBI.web.KPI_vistas_xlsx 
	</select>		
	<insert id="insertOrUpdateIncidenciasRelevantes_old"
		parameterType="com.telefonica.entity.IncidenciasRelevantes">

		UPDATE web.incidencias_relevantes
		SET Alias=#{alias},
		Tipo=#{tipo},
		Servicio_afectado=#{servicio_afectado},
		Causa=#{causa},
		Acciones_recuperacion=#{acciones_recuperacion},
		Acciones_mejora_responsables=#{acciones_mejora_responsables},
		Area=#{area},
		Contacto=#{contacto},
		Descripcion=#{descripcion},
		Severidad=#{severidad},
		Indisponibilidad=#{indisponibilidad},
		Fecha_inicio=#{fecha_inicio},
		Fecha_fin=#{fecha_fin},
		TipoSemMes=#{tipoSemMes}
		where num_incidencia = #{num_incidencia}
		and fecha = #{fecha}
		and cod_provincia = #{cod_provincia}

		IF @@rowcount = 0
		BEGIN
		INSERT INTO web.incidencias_relevantes
		(Alias,
		Tipo,
		Num_incidencia,
		Servicio_afectado,
		Causa,
		Acciones_recuperacion,
		Acciones_mejora_responsables,
		Area,
		Contacto,
		Descripcion,
		Severidad,
		Indisponibilidad,
		Fecha_inicio,
		Fecha_fin,
		Fecha,
		TipoSemMes,
		provincia,
		cod_provincia)
		VALUES(#{alias}, #{tipo}, #{num_incidencia}, #{servicio_afectado}, #{causa},
		#{acciones_recuperacion},#{acciones_mejora_responsables}, #{area},
		#{contacto}, #{descripcion}, #{severidad}, #{indisponibilidad},
		#{fecha_inicio}, #{fecha_fin}, #{fecha},
		#{tipoSemMes},#{provincia},#{cod_provincia})
		END
	</insert>
	<select id="insertOrUpdateIncidenciasRelevantes" resultType="int"
		parameterType="com.telefonica.entity.IncidenciasRelevantes">

				<if test="id_comite != ''">	
					INSERT INTO CDM_PBI.web.Incidencias_relevantes_historico
					(
					id_comite,
					[INDEX],
				    anno_cdm,
				    semana,
				    fecha_cdm,
				    n_incidencia,
				    tipo,
				    subtipo,
				    descripcion,
				    severidad,
				    fecha_inicio,
				    fecha_fin,
				    indisponibilidad,
				    alias,
				    servicio_afectado,
				    causa,
				    acciones_recuperacion,
				    acciones_mejora_responsables,
				    contacto,
				    area,
				    autor,
				    F_registro)
					VALUES(
					 (select top 1 idCdm from CDM_PBI.web.Instancia_CdM where N_periodo =  #{semana} and Year =  #{anno_cdm} and Tipo = 'SEM' ),
					#{INDEX},
					 #{anno_cdm},
					 #{semana},
					 (select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{semana} and Year =   #{anno_cdm}  and Tipo = 'SEM'),
					 #{n_incidencia},
					 #{tipo},
					 #{subtipo},
					 #{descripcion},
					 #{severidad},
					 #{fecha_inicio},
					 #{fecha_fin},
					 #{indisponibilidad},
					 #{alias},
					 #{servicio_afectado},
					 #{causa},
					 #{acciones_recuperacion},
					 #{acciones_mejora_responsables},
					 #{contacto},
					 #{area},
					 #{autor},
					  getdate()
					   );

		
		
					DELETE u FROM CDM_PBI.web.Incidencias_relevantes u
					WHERE u.id=#{id};
		
					INSERT INTO CDM_PBI.web.Incidencias_relevantes
					(
					id_comite,
					[INDEX],
				    anno_cdm,
				    semana,
				    fecha_cdm,
				    n_incidencia,
				    tipo,
				    subtipo,
				    descripcion,
				    severidad,
				    fecha_inicio,
				    fecha_fin,
				    indisponibilidad,
				    alias,
				    servicio_afectado,
				    causa,
				    acciones_recuperacion,
				    acciones_mejora_responsables,
				    contacto,
				    area,
				    autor,
				    F_registro)
					VALUES(
					 (select top 1 idCdm from CDM_PBI.web.Instancia_CdM where N_periodo =  #{semana} and Year =  #{anno_cdm} and Tipo = 'SEM' ),
					#{INDEX},
					#{anno_cdm},
					 #{semana},
					 (select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{semana} and Year =   #{anno_cdm}  and Tipo = 'SEM'),
					 #{n_incidencia},
					 #{tipo},
					 #{subtipo},
					 #{descripcion},
					 #{severidad},
					 #{fecha_inicio},
					 #{fecha_fin},
					 #{indisponibilidad},
					 #{alias},
					 #{servicio_afectado},
					 #{causa},
					 #{acciones_recuperacion},
					 #{acciones_mejora_responsables},
					 #{contacto},
					 #{area},
					 #{autor},
					  getdate()
					   );

		</if>
		<if test="id_comite == ''">
					 INSERT INTO CDM_PBI.web.Incidencias_relevantes
						(
						id_comite,
						[INDEX],
					    anno_cdm,
					    semana,
					    fecha_cdm,
					    n_incidencia,
					    tipo,
					    subtipo,
					    descripcion,
					    severidad,
					    fecha_inicio,
					    fecha_fin,
					    indisponibilidad,
					    alias,
					    servicio_afectado,
					    causa,
					    acciones_recuperacion,
					    acciones_mejora_responsables,
					    contacto,
					    area,
					    autor,
					    F_registro)
						VALUES(
						 (select top 1 idCdm from CDM_PBI.web.Instancia_CdM where N_periodo =  #{semana} and Year =  #{anno_cdm} and Tipo = 'SEM' ),
						 (cast((select isnull(max([Index]),0) from CDM_PBI.web.detalle_acciones_relevantes) as int)+1),
						 #{anno_cdm},
						 #{semana},
						 (select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{semana} and Year =   #{anno_cdm}  and Tipo = 'SEM'),
						 #{n_incidencia},
						 #{tipo},
						 #{subtipo},
						 #{descripcion},
						 #{severidad},
						 #{fecha_inicio},
						 #{fecha_fin},
						 #{indisponibilidad},
						 #{alias},
						 #{servicio_afectado},
						 #{causa},
						 #{acciones_recuperacion},
						 #{acciones_mejora_responsables},
						 #{contacto},
						 #{area},
						 #{autor},
						  getdate()
						   );
		
		</if>
			--Devuelve el ID insertado
			SELECT SCOPE_IDENTITY()
	</select>
	
	<insert id="updateIncidenciaDatosAdicionalesRegularizada" 
		parameterType="com.telefonica.entity.DatosAdicionalesRegularizaciones">

	SELECT *  FROM CDM_PBI.WEB.datos_adicionales_regularizaciones
	WHERE id_incidencia = #{idIncidencia}
	AND TIPO = #{tipo}
	AND provincia = #{provincia}
	AND Fecha = #{fecha}
	

	IF @@rowcount = 0
	BEGIN
		INSERT INTO CDM_PBI.web.datos_adicionales_regularizaciones
		(id,
		tipo,
		id_incidencia,
		sec_superior,
		Fecha,
		descripcion,
		solicitante,
		autorizador,
		provincia,
		eliminar,
		fecha_registro,
		autor)
		VALUES(
		'0',
		#{tipo},
		#{idIncidencia},
		#{secSuperior},
		#{fecha},
		#{descripcion},
		#{solicitante},
		#{autorizador},
		#{provincia},
		#{eliminar},
		getDate(),
		#{autor});
	END
	ELSE
	BEGIN
		
		insert into CDM_PBI.WEB.datos_adicionales_regularizaciones_historico 
		select id,
				tipo,
				id_incidencia,
				sec_superior,
				Fecha,
				descripcion,
				solicitante,
				autorizador,
				provincia,
				eliminar,
				fecha_registro,
				autor
		from CDM_PBI.WEB.datos_adicionales_regularizaciones
	
	
		DELETE  FROM CDM_PBI.WEB.datos_adicionales_regularizaciones
		WHERE id_incidencia = #{idIncidencia}
		AND TIPO = #{tipo}
		AND provincia = #{provincia}
		AND Fecha = #{fecha}
		
		INSERT INTO CDM_PBI.web.datos_adicionales_regularizaciones
		(id,
		tipo,
		id_incidencia,
		sec_superior,
		Fecha,
		descripcion,
		solicitante,
		autorizador,
		provincia,
		eliminar,
		fecha_registro,
		autor)
		VALUES(
		'0',
		#{tipo},
		#{idIncidencia},
		#{secSuperior},
		#{fecha},
		#{descripcion},
		#{solicitante},
		#{autorizador},
		#{provincia},
		#{eliminar},
		getDate(),
		#{autor});
	
	end
	
	--Devuelve el ID insertado
			SELECT SCOPE_IDENTITY()
	
	</insert>
	
	
	<insert id="insertListadoincidenciasRegularizada" 
		parameterType="com.telefonica.entity.ListadoIncidenciasRegularizadaNumeric">

		INSERT INTO
        CDM_PBI.web.listado_incidencias_regularizada
        (
                Tipo                                ,
                Red                                 ,
                Equipo                              ,
                Provincia                           ,
                ID                                  ,
                RESPONSABLE                         ,
                Fecha_Creacion                      ,
                Fecha_Reparacion                    ,
                Fecha_Franqueo                      ,
                Fecha_Cierre                        ,
                BA_Cobre_Clientes                   ,
                BA_Cobre_Indisponibilidad_Ponderada ,
                BA_Cobre_Duracion_Ponderada         ,
                BA_Cobre_Indisponibilidad           ,
                BA_Cobre_Duracion                   ,
                BA_Fibra_Clientes                   ,
                BA_Fibra_Indisponibilidad_Ponderada ,
                BA_Fibra_Duracion_Ponderada         ,
                BA_Fibra_Indisponibilidad           ,
                BA_Fibra_Duracion                   ,
                BA_Clientes                         ,
                BA_Indisponibilidad_Ponderada       ,
                BA_Duracion_Ponderada               ,
                BA_Indisponibilidad                 ,
                BA_Duracion                         ,
                Tv_Cobre_Clientes                   ,
                Tv_Cobre_Indisponibilidad_Ponderada ,
                Tv_Cobre_Duracion_Ponderada         ,
                Tv_Cobre_Indisponibilidad           ,
                Tv_Cobre_Duracion                   ,
                Tv_Fibra_Clientes                   ,
                Tv_Fibra_Indisponibilidad_Ponderada ,
                Tv_Fibra_Duracion_Ponderada         ,
                Tv_Fibra_Indisponibilidad           ,
                Tv_Fibra_Duracion                   ,
                Tv_Clientes                         ,
                Tv_Indisponibilidad_Ponderada       ,
                Tv_Duracion_Ponderada               ,
                Tv_Indisponibilidad                 ,
                Tv_Duracion                         ,
                Voz_Cobre_Clientes                  ,
                Voz_Cobre_Indisponibilidad_Ponderada,
                Voz_Cobre_Duracion_Ponderada        ,
                Voz_Cobre_Indisponibilidad          ,
                Voz_Cobre_Duracion                  ,
                Voz_Fibra_Clientes                  ,
                Voz_Fibra_Indisponibilidad_Ponderada,
                Voz_Fibra_Duracion_Ponderada        ,
                Voz_Fibra_Indisponibilidad          ,
                Voz_Fibra_Duracion                  ,
                Voz_Clientes                        ,
                Voz_Indisponibilidad_Ponderada      ,
                Voz_Duracion_Ponderada              ,
                Voz_Indisponibilidad                ,
                Voz_Duracion                        ,
                MFE_Clientes                        ,
                MFE_Indisponibilidad_Ponderada      ,
                MFE_Duracion_Ponderada              ,
                MFE_Indisponibilidad                ,
                MFE_Duracion                        ,
                FQ1                                 ,
                FQ2                                 ,
                FQ3                                 ,
                FQ4                                 ,
                FQ5                                 ,
                FQ6                                 ,
                SUMINISTRADOR                       ,
                TECNOLOGIA                          ,
                MODELO                              ,
                TIPO_DE_SINTOMA                     ,
                Falta_Repuesto                      ,
                Tiempo_Metereologico                ,
                Fecha                               ,
                Causa                               ,
                Causa_igri                          ,
                Subcausa_igri                       ,
                SEVERIDAD                           ,
                ACI_F_INICIO                        ,
                ACI_F_FIN                           ,
                ACI_DESCRIPCION                     ,
                ACI_CAUSA                           ,
                ACI_SAF                             ,
                ACI_ANALISIS                        ,
                ACI_SEVERIDAD                       ,
                ACI_LOCALIZACION                    ,
                id_problema                         ,
                concat_inc_1                        ,
                concat_inc_ave_pla                  ,
                concat_inc_ave_pla_2                ,
                Red_Incidencia                      ,
                edificio_dslam                      ,
                SUPERMASIVAS                        ,
                estado_gestion                      ,
                NEBA_FIBRA_CLIENTES                 ,
                NEBA_FIBRA_INDISPONIBILIDAD         ,
                NEBA_LOCAL_CLIENTES                 ,
                NEBA_LOCAL_INDISPONIBILIDAD         ,
                NEBA_COBRE_CLIENTES                 ,
                NEBA_COBRE_INDISPONIBILIDAD         ,
                NEBA_FIBRA_DURACION                 ,
                NEBA_LOCAL_DURACION                 ,
                NEBA_COBRE_DURACION
        )
        VALUES
        (
                #{tipo}                             ,
                #{red}                              ,
                #{equipo}                           ,
                #{provincia}                        ,
                #{id}                               ,
                #{responsable}                      ,
                #{fechaCreacion}                    ,
                #{fechaReparacion}                  ,
                #{fechaFranqueo}                    ,
                #{fechaCierre}                      ,
                #{baCobreClientes}                  ,
                #{baCobreIndisponibilidadPonderada} ,
                #{baCobreDuracionPonderada}         ,
                #{baCobreIndisponibilidad}          ,
                #{baCobreDuracion}                  ,
                #{baFibraClientes}                  ,
                #{baFibraIndisponibilidadPonderada} ,
                #{baFibraDuracionPonderada}         ,
                #{baFibraIndisponibilidad}          ,
                #{baFibraDuracion}                  ,
                #{baClientes}                       ,
                #{baIndisponibilidadPonderada}      ,
                #{baDuracionPonderada}              ,
                #{baIndisponibilidad}               ,
                #{baDuracion}                       ,
                #{tvCobreClientes}                  ,
                #{tvCobreIndisponibilidadPonderada} ,
                #{tvCobreDuracionPonderada}         ,
                #{tvCobreIndisponibilidad}          ,
                #{tvCobreDuracion}                  ,
                #{tvFibraClientes}                  ,
                #{tvFibraIndisponibilidadPonderada} ,
                #{tvFibraDuracionPonderada}         ,
                #{tvFibraIndisponibilidad}          ,
                #{tvFibraDuracion}                  ,
                #{tvClientes}                       ,
                #{tvIndisponibilidadPonderada}      ,
                #{tvDuracionPonderada}              ,
                #{tvIndisponibilidad}               ,
                #{tvDuracion}                       ,
                #{vozCobreClientes}                 ,
                #{vozCobreIndisponibilidadPonderada},
                #{vozCobreDuracionPonderada}        ,
                #{vozCobreIndisponibilidad}         ,
                #{vozCobreDuracion}                 ,
                #{vozFibraClientes}                 ,
                #{vozFibraIndisponibilidadPonderada},
                #{vozFibraDuracionPonderada}        ,
                #{vozFibraIndisponibilidad}         ,
                #{vozFibraDuracion}                 ,
                #{vozClientes}                      ,
                #{vozIndisponibilidadPonderada}     ,
                #{vozDuracionPonderada}             ,
                #{vozIndisponibilidad}              ,
                #{vozDuracion}                      ,
                #{mfeClientes}                      ,
                #{mfeIndisponibilidadPonderada}     ,
                #{mfeDuracionPonderada}             ,
                #{mfeIndisponibilidad}              ,
                #{mfeDuracion}                      ,
                #{fq1}                              ,
                #{fq2}                              ,
                #{fq3}                              ,
                #{fq4}                              ,
                #{fq5}                              ,
                #{fq6}                              ,
                #{suministrador}                    ,
                #{tecnologia}                       ,
                #{modelo}                           ,
                #{tipoDeSintoma}                    ,
                #{faltaRepuesto}                    ,
                #{tiempoMetereologico}              ,
                #{fecha}                            ,
                #{causa}                            ,
                #{causaIgri}                        ,
                #{subcausaIgri}                     ,
                #{severidad}                        ,
                #{aciFInicio}                       ,
                #{aciFFin}                          ,
                #{aciDescripcion}                   ,
                #{aciCausa}                         ,
                #{aciSaf}                           ,
                #{aciAnalisis}                      ,
                #{aciSeveridad}                     ,
                #{aciLocalizacion}                  ,
                #{idProblema}                       ,
                #{concatInc1}                       ,
                #{concatIncAvePla}                  ,
                #{concatIncAvePla2}                 ,
                #{redIncidencia}                    ,
                #{edificioDslam}                    ,
                #{supermasivas}                     ,
                #{estadoGestion}                    ,
                #{nebaFibraClientes}                ,
                #{nebaFibraIndisponibilidad}        ,
                #{nebaLocalClientes}                ,
                #{nebaLocalIndisponibilidad}        ,
                #{nebaCobreClientes}                ,
                #{nebaCobreIndisponibilidad}        ,
                #{nebaFibraDuracion}                ,
                #{nebaLocalDuracion}                ,
                #{nebaCobreDuracion}
        );
        
       
	
	</insert>
	<insert id="insertListadoincidenciasRegularizadaHistorico"
		parameterType="com.telefonica.entity.ListadoIncidenciasRegularizadaNumeric">
		
					INSERT INTO
        CDM_PBI.web.listado_incidencias_regularizada_historico
        (
                Tipo                                ,
                Red                                 ,
                Equipo                              ,
                Provincia                           ,
                ID                                  ,
                RESPONSABLE                         ,
                Fecha_Creacion                      ,
                Fecha_Reparacion                    ,
                Fecha_Franqueo                      ,
                Fecha_Cierre                        ,
                BA_Cobre_Clientes                   ,
                BA_Cobre_Indisponibilidad_Ponderada ,
                BA_Cobre_Duracion_Ponderada         ,
                BA_Cobre_Indisponibilidad           ,
                BA_Cobre_Duracion                   ,
                BA_Fibra_Clientes                   ,
                BA_Fibra_Indisponibilidad_Ponderada ,
                BA_Fibra_Duracion_Ponderada         ,
                BA_Fibra_Indisponibilidad           ,
                BA_Fibra_Duracion                   ,
                BA_Clientes                         ,
                BA_Indisponibilidad_Ponderada       ,
                BA_Duracion_Ponderada               ,
                BA_Indisponibilidad                 ,
                BA_Duracion                         ,
                Tv_Cobre_Clientes                   ,
                Tv_Cobre_Indisponibilidad_Ponderada ,
                Tv_Cobre_Duracion_Ponderada         ,
                Tv_Cobre_Indisponibilidad           ,
                Tv_Cobre_Duracion                   ,
                Tv_Fibra_Clientes                   ,
                Tv_Fibra_Indisponibilidad_Ponderada ,
                Tv_Fibra_Duracion_Ponderada         ,
                Tv_Fibra_Indisponibilidad           ,
                Tv_Fibra_Duracion                   ,
                Tv_Clientes                         ,
                Tv_Indisponibilidad_Ponderada       ,
                Tv_Duracion_Ponderada               ,
                Tv_Indisponibilidad                 ,
                Tv_Duracion                         ,
                Voz_Cobre_Clientes                  ,
                Voz_Cobre_Indisponibilidad_Ponderada,
                Voz_Cobre_Duracion_Ponderada        ,
                Voz_Cobre_Indisponibilidad          ,
                Voz_Cobre_Duracion                  ,
                Voz_Fibra_Clientes                  ,
                Voz_Fibra_Indisponibilidad_Ponderada,
                Voz_Fibra_Duracion_Ponderada        ,
                Voz_Fibra_Indisponibilidad          ,
                Voz_Fibra_Duracion                  ,
                Voz_Clientes                        ,
                Voz_Indisponibilidad_Ponderada      ,
                Voz_Duracion_Ponderada              ,
                Voz_Indisponibilidad                ,
                Voz_Duracion                        ,
                MFE_Clientes                        ,
                MFE_Indisponibilidad_Ponderada      ,
                MFE_Duracion_Ponderada              ,
                MFE_Indisponibilidad                ,
                MFE_Duracion                        ,
                FQ1                                 ,
                FQ2                                 ,
                FQ3                                 ,
                FQ4                                 ,
                FQ5                                 ,
                FQ6                                 ,
                SUMINISTRADOR                       ,
                TECNOLOGIA                          ,
                MODELO                              ,
                TIPO_DE_SINTOMA                     ,
                Falta_Repuesto                      ,
                Tiempo_Metereologico                ,
                Fecha                               ,
                Causa                               ,
                Causa_igri                          ,
                Subcausa_igri                       ,
                SEVERIDAD                           ,
                ACI_F_INICIO                        ,
                ACI_F_FIN                           ,
                ACI_DESCRIPCION                     ,
                ACI_CAUSA                           ,
                ACI_SAF                             ,
                ACI_ANALISIS                        ,
                ACI_SEVERIDAD                       ,
                ACI_LOCALIZACION                    ,
                id_problema                         ,
                concat_inc_1                        ,
                concat_inc_ave_pla                  ,
                concat_inc_ave_pla_2                ,
                Red_Incidencia                      ,
                edificio_dslam                      ,
                SUPERMASIVAS                        ,
                estado_gestion                      ,
                NEBA_FIBRA_CLIENTES                 ,
                NEBA_FIBRA_INDISPONIBILIDAD         ,
                NEBA_LOCAL_CLIENTES                 ,
                NEBA_LOCAL_INDISPONIBILIDAD         ,
                NEBA_COBRE_CLIENTES                 ,
                NEBA_COBRE_INDISPONIBILIDAD         ,
                NEBA_FIBRA_DURACION                 ,
                NEBA_LOCAL_DURACION                 ,
                NEBA_COBRE_DURACION
        )
        select  Tipo                                ,
                Red                                 ,
                Equipo                              ,
                Provincia                           ,
                ID                                  ,
                RESPONSABLE                         ,
                Fecha_Creacion                      ,
                Fecha_Reparacion                    ,
                Fecha_Franqueo                      ,
                Fecha_Cierre                        ,
                BA_Cobre_Clientes                   ,
                BA_Cobre_Indisponibilidad_Ponderada ,
                BA_Cobre_Duracion_Ponderada         ,
                BA_Cobre_Indisponibilidad           ,
                BA_Cobre_Duracion                   ,
                BA_Fibra_Clientes                   ,
                BA_Fibra_Indisponibilidad_Ponderada ,
                BA_Fibra_Duracion_Ponderada         ,
                BA_Fibra_Indisponibilidad           ,
                BA_Fibra_Duracion                   ,
                BA_Clientes                         ,
                BA_Indisponibilidad_Ponderada       ,
                BA_Duracion_Ponderada               ,
                BA_Indisponibilidad                 ,
                BA_Duracion                         ,
                Tv_Cobre_Clientes                   ,
                Tv_Cobre_Indisponibilidad_Ponderada ,
                Tv_Cobre_Duracion_Ponderada         ,
                Tv_Cobre_Indisponibilidad           ,
                Tv_Cobre_Duracion                   ,
                Tv_Fibra_Clientes                   ,
                Tv_Fibra_Indisponibilidad_Ponderada ,
                Tv_Fibra_Duracion_Ponderada         ,
                Tv_Fibra_Indisponibilidad           ,
                Tv_Fibra_Duracion                   ,
                Tv_Clientes                         ,
                Tv_Indisponibilidad_Ponderada       ,
                Tv_Duracion_Ponderada               ,
                Tv_Indisponibilidad                 ,
                Tv_Duracion                         ,
                Voz_Cobre_Clientes                  ,
                Voz_Cobre_Indisponibilidad_Ponderada,
                Voz_Cobre_Duracion_Ponderada        ,
                Voz_Cobre_Indisponibilidad          ,
                Voz_Cobre_Duracion                  ,
                Voz_Fibra_Clientes                  ,
                Voz_Fibra_Indisponibilidad_Ponderada,
                Voz_Fibra_Duracion_Ponderada        ,
                Voz_Fibra_Indisponibilidad          ,
                Voz_Fibra_Duracion                  ,
                Voz_Clientes                        ,
                Voz_Indisponibilidad_Ponderada      ,
                Voz_Duracion_Ponderada              ,
                Voz_Indisponibilidad                ,
                Voz_Duracion                        ,
                MFE_Clientes                        ,
                MFE_Indisponibilidad_Ponderada      ,
                MFE_Duracion_Ponderada              ,
                MFE_Indisponibilidad                ,
                MFE_Duracion                        ,
                FQ1                                 ,
                FQ2                                 ,
                FQ3                                 ,
                FQ4                                 ,
                FQ5                                 ,
                FQ6                                 ,
                SUMINISTRADOR                       ,
                TECNOLOGIA                          ,
                MODELO                              ,
                TIPO_DE_SINTOMA                     ,
                Falta_Repuesto                      ,
                Tiempo_Metereologico                ,
                Fecha                               ,
                Causa                               ,
                Causa_igri                          ,
                Subcausa_igri                       ,
                SEVERIDAD                           ,
                ACI_F_INICIO                        ,
                ACI_F_FIN                           ,
                ACI_DESCRIPCION                     ,
                ACI_CAUSA                           ,
                ACI_SAF                             ,
                ACI_ANALISIS                        ,
                ACI_SEVERIDAD                       ,
                ACI_LOCALIZACION                    ,
                id_problema                         ,
                concat_inc_1                        ,
                concat_inc_ave_pla                  ,
                concat_inc_ave_pla_2                ,
                Red_Incidencia                      ,
                edificio_dslam                      ,
                SUPERMASIVAS                        ,
                estado_gestion                      ,
                NEBA_FIBRA_CLIENTES                 ,
                NEBA_FIBRA_INDISPONIBILIDAD         ,
                NEBA_LOCAL_CLIENTES                 ,
                NEBA_LOCAL_INDISPONIBILIDAD         ,
                NEBA_COBRE_CLIENTES                 ,
                NEBA_COBRE_INDISPONIBILIDAD         ,
                NEBA_FIBRA_DURACION                 ,
                NEBA_LOCAL_DURACION                 ,
                NEBA_COBRE_DURACION
		
		from  CDM_PBI.web.listado_incidencias_regularizada
		where  id = #{id}
		AND tipo = #{tipo}
		AND provincia = #{provincia}
		AND fecha = #{fecha}
		
		
	</insert>
	
	<select id="getListadoincidenciasLlamadasRegularizada" resultType="int"
		parameterType="com.telefonica.entity.ListadoIncidenciasDisponibilidadLlamadasRegularizada">
		SELECT count(*) as data  FROM CDM_PBI.web.listado_Incidencias_Disponibilidad_Llamadas_regularizada
		WHERE sec_superior = #{secSuperior}
		AND TIPO = #{tipo}
		AND provincia = #{provincia}
		AND fecha = #{fecha}
	</select>
		<select id="getListadoincidenciasRegularizada" resultType="int"
		parameterType="com.telefonica.entity.ListadoIncidenciasRegularizadaNumeric">
		SELECT count(*) as data  FROM CDM_PBI.WEB.listado_incidencias_regularizada
		WHERE id = #{id}
		AND TIPO = #{tipo}
		AND provincia = #{provincia}
		AND Fecha = #{fecha}
	</select>
	<select id="insertListadoincidenciasLlamadasRegularizadaHistorico" resultType="int"
		parameterType="com.telefonica.entity.ListadoIncidenciasDisponibilidadLlamadasRegularizada">
		
		INSERT INTO
		        CDM_PBI.web.listado_Incidencias_Disponibilidad_Llamadas_regularizada_historico
		        (
		                fecha               ,
		                SEC_SUPERIOR        ,
		                PROVINCIA           ,
		                TIPO                ,
		                DATOS_COBRE         ,
		                DATOS_FIBRA         ,
		                VOZ                 ,
		                VOZ_IP              ,
		                TV_COBRE            ,
		                TV_FIBRA            ,
		                TV                  ,
		                MFE                 ,
		                DTH                 ,
		                OTT                 ,
		                NETFLIX             ,
		                DISNEY              ,
		                CLIE_DATOS_COBRE    ,
		                CLIE_DATOS_FIBRA    ,
		                CLIE_VOZ            ,
		                CLIE_VOZ_IP         ,
		                CLIE_TV_COBRE       ,
		                CLIE_TV_FIBRA       ,
		                CLIE_TV             ,
		                CLIE_MFE            ,
		                CLIE_DTH            ,
		                CLIE_OTT            ,
		                CLIE_NETFLIX        ,
		                CLIE_DISNEY         ,
		                DURACION_DATOS_COBRE,
		                DURACION_DATOS_FIBRA,
		                DURACION_VOZ        ,
		                DURACION_VOZ_IP     ,
		                DURACION_TV_COBRE   ,
		                DURACION_TV_FIBRA   ,
		                DURACION_TV         ,
		                DURACION_MFE        ,
		                DURACION_DTH        ,
		                DURACION_OTT        ,
		                DURACION_NETFLIX    ,
		                DURACION_DISNEY
		        ) select   
		        		fecha as datetime   ,
		                SEC_SUPERIOR        ,
		                PROVINCIA           ,
		                TIPO                ,
		                DATOS_COBRE         ,
		                DATOS_FIBRA         ,
		                VOZ                 ,
		                VOZ_IP              ,
		                TV_COBRE            ,
		                TV_FIBRA            ,
		                TV                  ,
		                MFE                 ,
		                DTH                 ,
		                OTT                 ,
		                NETFLIX             ,
		                DISNEY              ,
		                CLIE_DATOS_COBRE    ,
		                CLIE_DATOS_FIBRA    ,
		                CLIE_VOZ            ,
		                CLIE_VOZ_IP         ,
		                CLIE_TV_COBRE       ,
		                CLIE_TV_FIBRA       ,
		                CLIE_TV             ,
		                CLIE_MFE            ,
		                CLIE_DTH            ,
		                CLIE_OTT            ,
		                CLIE_NETFLIX        ,
		                CLIE_DISNEY         ,
		                DURACION_DATOS_COBRE,
		                DURACION_DATOS_FIBRA,
		                DURACION_VOZ        ,
		                DURACION_VOZ_IP     ,
		                DURACION_TV_COBRE   ,
		                DURACION_TV_FIBRA   ,
		                DURACION_TV         ,
		                DURACION_MFE        ,
		                DURACION_DTH        ,
		                DURACION_OTT        ,
		                DURACION_NETFLIX    ,
		               isnull(DURACION_DISNEY,0)
		                from  CDM_PBI.web.listado_Incidencias_Disponibilidad_Llamadas_regularizada
		                WHERE sec_superior = #{secSuperior}
						AND tipo = #{tipo}
						AND provincia = #{provincia}
						AND fecha = #{fecha}
		
		
		--Devuelve el ID insertado
			SELECT SCOPE_IDENTITY()
	</select>
	<insert id="deleteListadoincidenciasLlamadasRegularizadaHistorico" 
		parameterType="com.telefonica.entity.ListadoIncidenciasDisponibilidadLlamadasRegularizada">
		   DELETE FROM CDM_PBI.web.listado_Incidencias_Disponibilidad_Llamadas_regularizada
						WHERE sec_superior = #{secSuperior}
						AND tipo = #{tipo}
						AND provincia = #{provincia}
						AND fecha = #{fecha}
		
	</insert>
		<insert id="deleteListadoincidenciasRegularizada" 
		parameterType="com.telefonica.entity.ListadoIncidenciasRegularizadaNumeric">
		  		DELETE  FROM CDM_PBI.web.listado_incidencias_regularizada
				WHERE id = #{id}
				AND tipo = #{tipo}
				AND provincia = #{provincia}
				AND fecha = #{fecha}
		
	</insert>
		
	<select id="insertListadoincidenciasLlamadasRegularizada" resultType="int"
		parameterType="com.telefonica.entity.ListadoIncidenciasDisponibilidadLlamadasRegularizada">
		
		
			INSERT INTO
        CDM_PBI.web.listado_Incidencias_Disponibilidad_Llamadas_regularizada
        (
                fecha               ,
                SEC_SUPERIOR        ,
                PROVINCIA           ,
                TIPO                ,
                DATOS_COBRE         ,
                DATOS_FIBRA         ,
                VOZ                 ,
                VOZ_IP              ,
                TV_COBRE            ,
                TV_FIBRA            ,
                TV                  ,
                MFE                 ,
                DTH                 ,
                OTT                 ,
                NETFLIX             ,
                DISNEY              ,
                CLIE_DATOS_COBRE    ,
                CLIE_DATOS_FIBRA    ,
                CLIE_VOZ            ,
                CLIE_VOZ_IP         ,
                CLIE_TV_COBRE       ,
                CLIE_TV_FIBRA       ,
                CLIE_TV             ,
                CLIE_MFE            ,
                CLIE_DTH            ,
                CLIE_OTT            ,
                CLIE_NETFLIX        ,
                CLIE_DISNEY         ,
                DURACION_DATOS_COBRE,
                DURACION_DATOS_FIBRA,
                DURACION_VOZ        ,
                DURACION_VOZ_IP     ,
                DURACION_TV_COBRE   ,
                DURACION_TV_FIBRA   ,
                DURACION_TV         ,
                DURACION_MFE        ,
                DURACION_DTH        ,
                DURACION_OTT        ,
                DURACION_NETFLIX    ,
                DURACION_DISNEY
        )
        VALUES
        (
                    #{fecha},
					#{secSuperior},
					#{provincia},
					#{tipo},
					#{datosCobre},
					#{datosFibra},
					#{voz},
					#{vozIp},
					#{tvCobre},
					#{tvFibra},
					#{tv},
					#{mfe},
					#{dth},
					#{ott},
					#{netflix},
					#{disney},
					#{clieDatosCobre},
					#{clieDatosFibra},
					#{clieVoz},
					#{clieVozIp},
					#{clieTvCobre},
					#{clieTvFibra},
					#{clieTv},
					#{clieMfe},
					#{clieDth},
					#{clieOtt},
					#{clieNetflix},
					#{clieDisney},
					#{duracionDatosCobre},
					#{duracionDatosFibra},
					#{duracionVoz},
					#{duracionVozIp},
					#{duracionTvCobre},
					#{duracionTvFibra},
					#{duracionTv},
					#{duracionMfe},
					#{duracionDth},
					#{duracionOtt},
					#{duracionNetflix},
					isnull(#{duracionDisney},0)
        );
        
        --Devuelve el ID insertado
			SELECT SCOPE_IDENTITY()

	</select>
	<insert id="deleteIncidenciaRelevante"
		parameterType="com.telefonica.entity.IncidenciasRelevantes">
		DELETE u FROM CDM_PBI.web.Incidencias_relevantes u
		WHERE u.id = #{id};

	</insert>
	<select id="insertOrUpdateAccionesRelevantes" resultType="int"
		parameterType="com.telefonica.entity.AccionesRelevantes">
		
		<if test="id_comite != ''">	
				INSERT INTO CDM_PBI.web.detalle_acciones_relevantes_historico
					(Tipo, 
					Subtipo,
					Fecha_inicio,
					Fecha_fin,
					Titulo,
					codigo_BTP_CRQ,
					Descripcion,
					Impacto,
					Motivo,
					Promotor,
					Unidad_ejecutora,
				    Usuario_contacto,
				    Area, 
				    Fecha_CDM, 
				    Id_comite, 
				    [Index], 
				    Anno_cdm, 
				    Semana, 
				    Autor, 
				    [Timestamp])		    
					VALUES(
					#{tipo},
					#{subtipo},
					#{fecha_inicio},
					#{fecha_fin},
					#{titulo},
					#{codigo_BTP_CRQ},
					#{descripcion},
					#{impacto},
					#{motivo},
					#{promotor},
					#{unidad_ejecutora},
					#{usuario_contacto},
					#{area},
					#{fecha_cdm},
					#{id_comite},
					#{index},
					#{anno_cdm},
					#{semana},
					#{autor},
					#{timestamp});
		
		
					DELETE u FROM CDM_PBI.web.detalle_acciones_relevantes u
					WHERE u.id=#{id} ;
		
					INSERT INTO CDM_PBI.web.detalle_acciones_relevantes
						(Tipo, 
						Subtipo,
						Fecha_inicio,
						Fecha_fin,
						Titulo,
						codigo_BTP_CRQ,
						Descripcion,
						Impacto,
						Motivo,
						Promotor,
						Unidad_ejecutora,
					    Usuario_contacto,
					    Area, 
					    Fecha_CDM, 
					    Id_comite, 
					    [Index], 
					    Anno_cdm, 
					    Semana, 
					    Autor, 
					    [Timestamp])
						VALUES(
						#{tipo},
						#{subtipo},
						#{fecha_inicio},
						#{fecha_fin},
						#{titulo},
						#{codigo_BTP_CRQ},
						#{descripcion},
						#{impacto},
						#{motivo},
						#{promotor},
						#{unidad_ejecutora},
						#{usuario_contacto},
						#{area},
						(select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{semana} and Year =   #{anno_cdm}  and Tipo = 'SEM'),
						(select top 1 idCdm from CDM_PBI.web.Instancia_CdM where N_periodo =  #{semana} and Year =  #{anno_cdm} and Tipo = 'SEM' ),
						#{index},
						#{anno_cdm},
						#{semana},
						#{autor},
						#{timestamp});
		</if>
		
		<if test="id_comite == ''">
				INSERT INTO CDM_PBI.web.detalle_acciones_relevantes
					(Tipo, 
					Subtipo,
					Fecha_inicio,
					Fecha_fin,
					Titulo,
					codigo_BTP_CRQ,
					Descripcion,
					Impacto,
					Motivo,
					Promotor,
					Unidad_ejecutora,
				    Usuario_contacto,
				    Area, 
				    Fecha_CDM, 
				    Id_comite, 
				    [Index], 
				    Anno_cdm, 
				    Semana, 
				    Autor, 
				    [Timestamp])
					VALUES(
					#{tipo},
					#{subtipo},
					#{fecha_inicio},
					#{fecha_fin},
					#{titulo},
					#{codigo_BTP_CRQ},
					#{descripcion},
					#{impacto},
					#{motivo},
					#{promotor},
					#{unidad_ejecutora},
					#{usuario_contacto},
					#{area},
					(select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{semana} and Year =   #{anno_cdm}  and Tipo = 'SEM'),
					(select top 1 idCdm from CDM_PBI.web.Instancia_CdM where N_periodo =  #{semana} and Year =  #{anno_cdm} and Tipo = 'SEM' ),
					(cast((select isnull(max([Index]),0)+1 from CDM_PBI.web.detalle_acciones_relevantes) as int)),
					#{anno_cdm},
					#{semana},
					#{autor},
					getdate()
					);
		
		</if>
			--Devuelve el ID insertado
			SELECT SCOPE_IDENTITY()
	</select>
	
	<insert id="deleteAccionesRelevantes"
		parameterType="com.telefonica.entity.AccionesRelevantes">
		DELETE u FROM web.detalle_acciones_relevantes u
		WHERE u.id = #{id};

	</insert>
	<select id="insertOrUpdateComentarios"  resultType="int"
		parameterType="com.telefonica.entity.Comentarios">
		
		<if test="id_comite != ''">
		
		
			<if test="tipo_periodo == 'SEMANAL'">

			INSERT INTO CDM_PBI.web.Comentarios_historico
			(Comentario_1, 
			Comentario_2,
			Comentario_3,
			Autor,
			[Timestamp],
			id_comite,
			Tipo_periodo,
			Fecha,
			Vista,
			id_vista,
			KPI,
			Tipo_comentario)
			select replace(Comentario_1,'\n',CHAR(10)) ,
				replace(Comentario_2,'\n',CHAR(10)) ,
			    replace(Comentario_3,'\n',CHAR(10)) ,
					Autor,
					[Timestamp],
					id_comite,
					Tipo_periodo,
					Fecha,
					Vista,
					id_vista,
					KPI,
					Tipo_comentario from CDM_PBI.Web.Comentarios where id_comite = #{id_comite} and convert(nvarchar(MAX), Timestamp, 20) ='${timestampString}'
			
			delete u from CDM_PBI.Web.Comentarios u where u.id_comite =  #{id_comite} and convert(nvarchar(MAX), Timestamp, 20) ='${timestampString}'
			
			INSERT INTO CDM_PBI.web.Comentarios
			(Comentario_1, Comentario_2, Comentario_3, Autor, [Timestamp], id_comite, Tipo_periodo, Fecha, Vista, id_vista, KPI, Tipo_comentario)
			VALUES(
			replace(#{comentario_1},'\n',CHAR(10)) ,
			replace(#{comentario_2},'\n',CHAR(10)) ,
			replace(#{comentario_3},'\n',CHAR(10)) ,
			 #{autor},
			  #{timestamp},
			 #{id_comite},
			 #{tipo_periodo},
		  	(select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{n_periodo} and Year =  #{annio_sel} and Tipo = 'SEM'),
			 #{vista},
			(select Top 1 id_vista from CDM_PBI.web.KPI_vistas_xlsx where Vista = #{vista} ),
			 #{kpi},
			 #{tipo_comentario});

			</if>
			
			<if test="tipo_periodo == 'MENSUAL'">

			INSERT INTO CDM_PBI.web.Comentarios_historico
			(Comentario_1, Comentario_2, Comentario_3, Autor, [Timestamp], id_comite, Tipo_periodo, Fecha, Vista, id_vista, KPI, Tipo_comentario)
			select replace(comentario_1,'\n',CHAR(10)) ,
				   replace(comentario_2,'\n',CHAR(10)) ,
				   replace(comentario_3,'\n',CHAR(10)) ,
					Autor,
					[Timestamp],
					id_comite,
					Tipo_periodo,
					Fecha,
					Vista,
					id_vista,
					KPI,
					Tipo_comentario from CDM_PBI.Web.Comentarios where id_comite = #{id_comite} and convert(nvarchar(MAX), Timestamp, 20) ='${timestampString}' 
			
			delete u from CDM_PBI.Web.Comentarios u where u.id_comite =  #{id_comite} and convert(nvarchar(MAX), Timestamp, 20) ='${timestampString}'
			
			INSERT INTO CDM_PBI.web.Comentarios
			(Comentario_1, Comentario_2, Comentario_3, Autor, [Timestamp], id_comite, Tipo_periodo, Fecha, Vista, id_vista, KPI, Tipo_comentario)
			VALUES(
			replace(#{comentario_1},'\n',CHAR(10)) ,
			replace(#{comentario_2},'\n',CHAR(10)) ,
			replace(#{comentario_3},'\n',CHAR(10)) ,
			  #{autor},
			  #{timestamp},
			  #{id_comite},
			  #{tipo_periodo},
		 	(select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{n_periodo} and Year =   #{annio_sel} and Tipo = 'MES'),
			  #{vista},
			(select Top 1 id_vista from CDM_PBI.web.KPI_vistas_xlsx where Vista = #{vista} ),
			 #{kpi},
			 #{tipo_comentario});

			</if>
		
		</if>
		
		<if test="id_comite == ''">
		
			<if test="tipo_periodo == 'SEMANAL'">
		
				INSERT INTO CDM_PBI.web.Comentarios
				(Comentario_1, Comentario_2, Comentario_3, Autor, [Timestamp], id_comite, Tipo_periodo, Fecha, Vista, id_vista, KPI, Tipo_comentario)
				VALUES(
				replace(#{comentario_1},'\n','\\n') ,
				replace(#{comentario_2},'\n',CHAR(13)) ,
				replace(#{comentario_3},'\n',CHAR(13)) ,#{autor}, getDate(),
				 (select top 1 idCdm from CDM_PBI.web.Instancia_CdM where N_periodo = #{n_periodo} and Year = #{annio_sel} and Tipo = 'SEM' ),
				 #{tipo_periodo},
			  (select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{n_periodo} and Year =   #{annio_sel}  and Tipo = 'SEM'),
				 #{vista},
				(select Top 1 id_vista from CDM_PBI.web.KPI_vistas_xlsx where Vista = #{vista} ),
				 #{kpi},  #{tipo_comentario});
			 </if>
			<if test="tipo_periodo == 'MENSUAL'">
			
				INSERT INTO CDM_PBI.web.Comentarios
				(Comentario_1, Comentario_2, Comentario_3, Autor, [Timestamp], id_comite, Tipo_periodo, Fecha, Vista, id_vista, KPI, Tipo_comentario)
				VALUES(
				replace(#{comentario_1},'\n',CHAR(10)) ,
				replace(#{comentario_2},'\n',CHAR(10)) ,
				replace(#{comentario_3},'\n',CHAR(10)) ,#{autor}, getDate(),
				 (select top 1 idCdm from CDM_PBI.web.Instancia_CdM where N_periodo =  #{n_periodo} and Year =  #{annio_sel} and Tipo = 'MES' ),
				 #{tipo_periodo}
				 ,(select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{n_periodo} and Year =  #{annio_sel} and Tipo = 'MES'),
				  #{vista},
				(select Top 1 id_vista from CDM_PBI.web.KPI_vistas_xlsx where Vista = #{vista} ),
				 #{kpi},  #{tipo_comentario});
			</if>
			
		
		</if> 	
		
		SELECT SCOPE_IDENTITY()
	</select>
	<select id="insertOrUpdateComentariosIncidencias"  resultType="int"
		parameterType="com.telefonica.entity.ComentariosIncidencias">
		
		<if test="id_comite != ''">
		
		
			<if test="tipo_periodo == 'SEMANAL'">
			
				
				INSERT INTO CDM_PBI.web.Desc_inc_destacadas_historico
				(id_comite, Tipo_periodo, N_periodo, Fecha, ID_incidencia, Alias, Descripcion_manual, Autor, [Timestamp])
				SELECT  id_comite, Tipo_periodo, N_periodo, Fecha, ID_incidencia, Alias, Descripcion_manual, Autor, [Timestamp]
				FROM CDM_PBI.web.Desc_inc_destacadas where id_comite = #{id_comite} and convert(nvarchar(MAX), Timestamp, 20) ='${timestampString}';
	
				delete u from CDM_PBI.Web.Desc_inc_destacadas u where u.id_comite =  #{id_comite} and convert(nvarchar(MAX), Timestamp, 20) ='${timestampString}'
				
				
				INSERT INTO CDM_PBI.web.Desc_inc_destacadas
				(id_comite, Tipo_periodo, N_periodo, Fecha, ID_incidencia, Alias, Descripcion_manual, Autor, [Timestamp])
				VALUES(#{id_comite},
					#{tipo_periodo},
					#{n_periodo},
					(select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{n_periodo} and Year =  #{annio_sel} and Tipo = 'SEM'),
	                #{id_incidencia},
	                #{alias},
	                #{descripcion_manual},
	                #{autor},
	                #{timestamp});
			

			</if>
			
			<if test="tipo_periodo == 'MENSUAL'">

				INSERT INTO CDM_PBI.web.Desc_inc_destacadas_historico
				(id_comite, Tipo_periodo, N_periodo, Fecha, ID_incidencia, Alias, Descripcion_manual, Autor, [Timestamp])
				SELECT  id_comite, Tipo_periodo, N_periodo, Fecha, ID_incidencia, Alias, Descripcion_manual, Autor, [Timestamp]
				FROM CDM_PBI.web.Desc_inc_destacadas where id_comite = #{id_comite} and convert(nvarchar(MAX), Timestamp, 20) ='${timestampString}';
	
				delete u from CDM_PBI.Web.Desc_inc_destacadas u where u.id_comite =  #{id_comite} and convert(nvarchar(MAX), Timestamp, 20) ='${timestampString}'
				
				
				INSERT INTO CDM_PBI.web.Desc_inc_destacadas
				(id_comite, Tipo_periodo, N_periodo, Fecha, ID_incidencia, Alias, Descripcion_manual, Autor, [Timestamp])
				VALUES(#{id_comite},
					#{tipo_periodo},
					#{n_periodo},
					(select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{n_periodo} and Year =  #{annio_sel} and Tipo = 'MES'),
	                #{id_incidencia},
	                #{alias},
	                #{descripcion_manual},
	                #{autor},
	                #{timestamp});

			</if>
		
		</if>
		
		<if test="id_comite == ''">
		
			<if test="tipo_periodo == 'SEMANAL'">
		

				INSERT INTO CDM_PBI.web.Desc_inc_destacadas
				(id_comite, Tipo_periodo, N_periodo, Fecha, ID_incidencia, Alias, Descripcion_manual, Autor, [Timestamp])
				VALUES( (select top 1 idCdm from CDM_PBI.web.Instancia_CdM where N_periodo =  #{n_periodo} and Year =  #{annio_sel} and Tipo = 'SEM' ),
					#{tipo_periodo},
					#{n_periodo},
					(select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{n_periodo} and Year =  #{annio_sel} and Tipo = 'SEM'),
	                #{id_incidencia},
	                #{alias},
	                #{descripcion_manual},
	                #{autor},
	               getDate());

			 </if>
			<if test="tipo_periodo == 'MENSUAL'">
			
				INSERT INTO CDM_PBI.web.Desc_inc_destacadas
				(id_comite, Tipo_periodo, N_periodo, Fecha, ID_incidencia, Alias, Descripcion_manual, Autor, [Timestamp])
				VALUES((select top 1 idCdm from CDM_PBI.web.Instancia_CdM where N_periodo =  #{n_periodo} and Year =  #{annio_sel} and Tipo = 'MES' ),
					#{tipo_periodo},
					#{n_periodo},
					(select fecha from CDM_PBI.web.Instancia_CdM where N_periodo =  #{n_periodo} and Year =  #{annio_sel} and Tipo = 'MES'),
	                #{id_incidencia},
	                #{alias},
	                #{descripcion_manual},
	                #{autor},
	                 getDate());
			</if>
			
		
		</if> 	
		
		SELECT SCOPE_IDENTITY()
	</select>
	
	
	
	<insert id="deleteComentarios"
		parameterType="com.telefonica.entity.Comentarios">
		DELETE FROM CDM_PBI.web.Comentarios
		WHERE  id_comite like '%${id_comite}%' AND  convert(nvarchar(MAX), Timestamp, 20) ='${timestampString}'


	</insert>
	
	<insert id="deleteComentariosIncidencias"
		parameterType="com.telefonica.entity.ComentariosIncidencias">
		
		DELETE FROM CDM_PBI.web.Desc_inc_destacadas
		WHERE  id_comite like '%${id_comite}%' AND  convert(nvarchar(MAX), Timestamp, 20) ='${timestampString}'


	</insert>

	<insert id="altaUsuario"
		parameterType="com.telefonica.entity.Usuario">

		-- Damos de alta el Usuario
		INSERT INTO GRILLOv2.grilloweb.Usuarios (matricula, password, nombre,
		apellidos)
		VALUES (#{matricula}, #{matricula}, #{nombre}, #{apellidos})

		<foreach collection="roles" item="rol">

			-- Le damos los roles
			INSERT INTO GRILLOv2.grilloweb.Usuarios_Roles (ID_USUARIO, COD_ROL)
			VALUES ((SELECT ID_USUARIO FROM GRILLOv2.grilloweb.Usuarios WHERE matricula
			= #{matricula}), #{rol.codRol})

		</foreach>

	</insert>
</mapper> <!-- <mapper namespace="com.bd.mapper.DB_Mapper"> -->